{% extends 'layout.html.twig' %}

{% block title %}Rechercher un covoiturage{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .suggestions-list {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-city {
            font-weight: 500;
            color: #212529;
            display: flex;
            align-items: center;
        }

        .suggestion-city i {
            margin-right: 8px;
            color: #198754;
        }

        .suggestion-context {
            font-size: 0.875rem;
            color: #6c757d;
            margin-left: 28px;
        }

        .suggestion-postcode {
            font-size: 0.875rem;
            color: #adb5bd;
            margin-left: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .search-bar-section {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
{% endblock %}

{% block content %}
<main class="bg-light">
    {# Barre de recherche du trajet #}
    <section class="search-bar-section py-3">
        <div class="container-xxl">
            <form class="row g-2 align-items-end" id="searchForm" method="GET" action="{{ path('app_ride_index') }}">
                <div class="col-12 col-lg-3">
                    <label class="form-label fw-semibold small" for="departure">
                        <i class="bi bi-geo-alt-fill text-success"></i> Départ
                    </label>
                    <div class="input-wrapper">
                        <input  class="form-control form-control-sm"
                            type="text"
                            id="departure"
                            name="departure"
                            placeholder="Ville de départ"
                            value="{{ app.request.query.get('departure')|default('') }}"
                            required
                            autocomplete="off">
                        <div id="departureSuggestions" class="suggestions-list"></div>
                    </div>
                </div>
                <div class="col-12 col-lg-3">
                    <label class="form-label fw-semibold small" for="arrival">
                        <i class="bi bi-geo-alt text-success"></i> Destination
                    </label>
                    <div class="input-wrapper">
                        <input class="form-control form-control-sm"
                            type="text"
                            id="arrival"
                            name="arrival"
                            placeholder="Ville d'arrivée"
                            value="{{ app.request.query.get('arrival')|default('') }}"
                            required
                            autocomplete="off">
                        <div id="arrivalSuggestions" class="suggestions-list"></div>
                    </div>
                </div>
                <div class="col-12 col-lg-2">
                    <label class="form-label fw-semibold small" for="date">
                        <i class="bi bi-calendar-event text-success"></i> Date
                    </label>
                    <input class="form-control form-control-sm"
                        type="date"
                        id="date"
                        name="date"
                        value="{{ app.request.query.get('date')|default('') }}"
                        required>
                </div>
                <div class="col-12 col-lg-3">
                    <button type="submit" class="btn btn-search w-100 btn-sm">
                        <i class="bi bi-search"></i> Rechercher
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Filtres et résultats de recherche -->
    <section class="results-section py-4">
        <div class="container-xxl">
            <div class="row g-4">
                <!-- Colonne des filtres (gauche) -->
                <aside class="col-12 col-lg-3">
                    <div class="filters-container">
                        <h3 class="fw-bold mb-4">
                            <i class="bi bi-funnel"></i> Filtres
                        </h3>
                        <form id="filtersForm" method="GET" action="{{ path('app_ride_index') }}">
                            <!-- Conserver les paramètres de recherche -->
                            <input type="hidden" name="departure" value="{{ app.request.query.get('departure')|default('') }}">
                            <input type="hidden" name="arrival" value="{{ app.request.query.get('arrival')|default('') }}">
                            <input type="hidden" name="date" value="{{ app.request.query.get('date')|default('') }}">

                            <!-- Filtre Voiture électrique -->
                            <div class="filter-group mb-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-ev-front"></i> Voyage écologique
                                </label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="electric" name="electric" value="1"
                                        {{ app.request.query.get('electric') ? 'checked' : '' }}>
                                    <label class="form-check-label" for="electric">
                                        Voiture électrique uniquement
                                    </label>
                                </div>
                            </div>

                            <!-- Filtre Prix maximum -->
                            <div class="filter-group mb-4">
                                <label class="form-label fw-semibold" for="max_price">
                                    <i class="bi"></i> Prix maximum
                                </label>
                                <div class="input-group input-group-sm">
                                    <input
                                        type="number"
                                        class="form-control"
                                        id="max_price"
                                        name="max_price"
                                        placeholder="Ex: 50"
                                        min="0"
                                        step="5"
                                        value="{{ app.request.query.get('max_price')|default('') }}">
                                    <span class="input-group-text">crédits</span>
                                </div>
                            </div>

                             <!-- Filtre durée maximum -->
                            <div class="filter-group mb-4">
                                <label class="form-label fw-semibold" for="max_duration">
                                    <i class="bi"></i> Durée maximale
                                </label>
                                <select class="form-select form-select-sm" id="max_duration" name="max_duration">
                                    <option value="">Toutes les durées</option>
                                    <option value="60" {{ app.request.query.get('max_duration') == '60' ? 'selected' : '' }}>Moins d'1h</option>
                                    <option value="120" {{ app.request.query.get('max_duration') == '120' ? 'selected' : '' }}>Moins de 2h</option>
                                    <option value="180" {{ app.request.query.get('max_duration') == '180' ? 'selected' : '' }}>Moins de 3h</option>
                                    <option value="240" {{ app.request.query.get('max_duration') == '240' ? 'selected' : '' }}>Moins de 4h</option>
                                    <option value="300" {{ app.request.query.get('max_duration') == '300' ? 'selected' : '' }}>Moins de 5h</option>
                                    <option value="360" {{ app.request.query.get('max_duration') == '360' ? 'selected' : '' }}>Moins de 6h</option>
                                    <option value="420" {{ app.request.query.get('max_duration') == '420' ? 'selected' : '' }}>Moins de 7h</option>
                                </select>
                            </div>

                            <!-- Boutons -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-search btn-sm">
                                    <i class="bi bi-check2"></i> Appliquer les filtres
                                </button>
                                <a href="{{ path('app_ride_index', {
                                    departure: app.request.query.get('departure')|default(''),
                                    arrival: app.request.query.get('arrival')|default(''),
                                    date: app.request.query.get('date')|default('')
                                }) }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-x-circle"></i> Réinitialiser
                                </a>
                            </div>
                        </form>
                    </div>
                </aside>

                <!-- Colonne des résultats (droite) -->
                <div class="col-12 col-lg-9">
                    <div class="results-header mb-3 d-flex justify-content-between align-items-center">
                        <h2 class="h4 fw-bold mb-0">
                            {% if app.request.query.get('departure') and app.request.query.get('arrival') %}
                                Trajets de {{ app.request.query.get('departure') }} à {{ app.request.query.get('arrival') }}
                            {% else %}
                                Trajets disponibles
                            {% endif %}
                        </h2>
                        <div class="results-count text-muted">
                            <small>
                                {{ rides|length }} résultat(s) trouvé(s)
                            </small>
                        </div>
                    </div>

                    <!-- Listing des résultats de trajets disponibles -->
                    <div class="results-list">
                        {% if rides|length > 0 %}
                            {% for ride in rides %}
                                <div class="card mb-3 shadow-sm ride-card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-12 col-md-8">
                                                <div class="d-flex align-items-center mb-2">
                                                    <img src="{{ asset('img/default-avatar.png') }}" alt="Avatar" class="rounded-circle me-3" width="50" height="50">
                                                    <div>
                                                        <h5 class="mb-0">{{ ride.driver.firstName }} {{ ride.driver.lastName }}</h5>
                                                        <small class="text-muted">⭐ Nouveau conducteur</small>
                                                    </div>
                                                    {% if ride.car.isElectric %}
                                                        <span class="badge bg-success ms-3">
                                                            <i class="bi bi-ev-front"></i> Écologique
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="ride-details">
                                                    <p class="mb-1">
                                                        <i class="bi bi-calendar-event text-success"></i>
                                                        <strong>{{ ride.departureDate|date('d/m/Y') }}</strong>
                                                    </p>
                                                    <p class="mb-1">
                                                        <i class="bi bi-clock text-success"></i>
                                                        <strong>{{ ride.departureTime|date('H:i') }}</strong>
                                                        {{ ride.departurePlace }} →
                                                        <strong>{{ ride.arrivalTime|date('H:i') }}</strong>
                                                        {{ ride.arrivalPlace }}
                                                    </p>
                                                    <p class="mb-0 text-muted small">
                                                        <i class="bi bi-person"></i> {{ ride.remainingSeats }} place(s) disponible(s)
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="col-12 col-md-4 text-md-end mt-3 mt-md-0">
                                                <div class="price-section">
                                                    <p class="h4 fw-bold mb-2 text-success">{{ ride.pricePerSeat|number_format(0) }} crédits</p>
                                                    <a href="{{ path('app_ride_show', {id: ride.id}) }}" class="btn btn-search btn-sm w-100">
                                                        Voir le détail
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="card shadow-sm">
                                <div class="card-body text-center py-5">
                                    <i class="bi bi-search display-1 text-muted mb-3"></i>
                                    <h3 class="h5 text-muted">Aucun trajet trouvé</h3>
                                    {% if app.request.query.get('departure') and app.request.query.get('arrival') %}
                                        <p class="text-muted">
                                            Aucun trajet disponible de <strong>{{ app.request.query.get('departure') }}</strong> 
                                            à <strong>{{ app.request.query.get('arrival') }}</strong>
                                            {% if app.request.query.get('date') %}
                                                le <strong>{{ app.request.query.get('date')|date('d/m/Y') }}</strong>
                                            {% endif %}
                                        </p>
                                    {% else %}
                                        <p class="text-muted">Essayez de modifier vos critères de recherche</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration
            const MIN_CHARS = 2;
            const DEBOUNCE_DELAY = 300;
            
            /**
             * Configure l'autocomplétion pour un champ de ville
             */
            function setupCityAutocomplete(inputId, suggestionsId) {
                const input = document.getElementById(inputId);
                const suggestionsDiv = document.getElementById(suggestionsId);
                let debounceTimer;
                
                input.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    const query = this.value.trim();
                    
                    if (query.length < MIN_CHARS) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }
                    
                    debounceTimer = setTimeout(() => {
                        fetchCities(query, suggestionsDiv, input);
                    }, DEBOUNCE_DELAY);
                });
                
                // Navigation au clavier
                input.addEventListener('keydown', function(e) {
                    const items = suggestionsDiv.querySelectorAll('.suggestion-item');
                    const activeItem = suggestionsDiv.querySelector('.suggestion-item.active');
                    
                    if (e.key === 'ArrowDown' && items.length > 0) {
                        e.preventDefault();
                        if (!activeItem) {
                            items[0].classList.add('active');
                        } else {
                            const nextItem = activeItem.nextElementSibling;
                            if (nextItem) {
                                activeItem.classList.remove('active');
                                nextItem.classList.add('active');
                            }
                        }
                    } else if (e.key === 'ArrowUp' && items.length > 0) {
                        e.preventDefault();
                        if (activeItem) {
                            const prevItem = activeItem.previousElementSibling;
                            if (prevItem) {
                                activeItem.classList.remove('active');
                                prevItem.classList.add('active');
                            }
                        }
                    } else if (e.key === 'Enter' && activeItem) {
                        e.preventDefault();
                        activeItem.click();
                    } else if (e.key === 'Escape') {
                        suggestionsDiv.style.display = 'none';
                    }
                });
                
                // Fermer les suggestions si on clique ailleurs
                document.addEventListener('click', function(e) {
                    if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }
            
            /**
             * Récupère les villes depuis l'API
             */
            async function fetchCities(query, suggestionsDiv, input) {
                try {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted"><i class="bi bi-hourglass-split me-2"></i>Recherche en cours...</div>';
                    suggestionsDiv.style.display = 'block';
                    
                    const response = await fetch(
                        `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&fields=nom,code,codesPostaux,codeDepartement,population&boost=population&limit=8`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Erreur de recherche');
                    }
                    
                    const cities = await response.json();
                    displaySuggestions(cities, suggestionsDiv, input);
                    
                } catch (error) {
                    console.error('Erreur lors de la recherche:', error);
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Erreur de chargement</div>';
                    suggestionsDiv.style.display = 'block';
                }
            }
            
            /**
             * Affiche les suggestions de villes
             */
            function displaySuggestions(cities, suggestionsDiv, input) {
                if (cities.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted"><i class="bi bi-info-circle me-2"></i>Aucune ville trouvée</div>';
                    suggestionsDiv.style.display = 'block';
                    return;
                }
                
                suggestionsDiv.innerHTML = '';
                
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    const cityName = city.nom;
                    const postcode = city.codesPostaux ? city.codesPostaux[0] : '';
                    const dept = city.codeDepartement || '';
                    
                    item.innerHTML = `
                        <div class="suggestion-city">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>${cityName}</span>
                            ${postcode ? `<span class="suggestion-postcode">(${postcode})</span>` : ''}
                        </div>
                        ${dept ? `<div class="suggestion-context">Département ${dept}</div>` : ''}
                    `;
                    
                    item.addEventListener('click', function() {
                        input.value = cityName;
                        input.dataset.cityCode = city.code;
                        input.dataset.cityPostcode = postcode;
                        suggestionsDiv.style.display = 'none';
                    });
                    
                    suggestionsDiv.appendChild(item);
                });
                
                suggestionsDiv.style.display = 'block';
            }
            
            // Initialiser l'autocomplétion
            setupCityAutocomplete('departure', 'departureSuggestions');
            setupCityAutocomplete('arrival', 'arrivalSuggestions');
        });
    </script>
{% endblock %}
{% endblock %}