{% extends 'layout.html.twig' %}

{% block title %}EcoRide{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .suggestions-list {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            margin-top: 2px;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-city {
            font-weight: 500;
            color: #212529;
            display: flex;
            align-items: center;
        }

        .suggestion-city i {
            margin-right: 8px;
            color: #198754;
        }

        .suggestion-context {
            font-size: 0.875rem;
            color: #6c757d;
            margin-left: 28px;
        }

        .suggestion-postcode {
            font-size: 0.875rem;
            color: #adb5bd;
            margin-left: 8px;
        }

        .input-wrapper {
            position: relative;
        }
    </style>
{% endblock %}

{% block content %}
<main>
    <section class="section-hero">
        <div class="hero-banner">
            <img class="hero-bg-img" src="img/roadtrip1.jpg" alt="Covoiturage nature">
            <div class="hero-overlay"></div>
            <div class="hero-text-overlay">
                <div class="container-xxl">
                    <h1 class="text-white fw-bold text-center">EcoRide, le covoiturage vert à la portée de TOUS !</h1>
                    <p class="hero-subtitle text-center">Partagez vos trajets, réduisez votre empreinte carbone et voyagez de manière responsable.</p>
                </div>
            </div>
        </div> 
        <div class="container-xxl">
            <div class="search-form-container-home mx-auto">
                <form class="row g-3 align-items-end" id="searchForm" method="GET" action="{{ path('app_home_search') }}">
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold" for="departure">
                            <i class="bi bi-geo-alt-fill text-success"></i> Départ
                        </label>
                        <div class="input-wrapper">
                            <input
                                class="form-control form-control-custom" 
                                type="text"
                                id="departure"
                                name="departure"
                                placeholder="Ville de départ"
                                required
                                autocomplete="off">
                            <div id="departureSuggestions" class="suggestions-list"></div>
                        </div>
                    </div>
            
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold" for="destination">
                            <i class="bi bi-geo-alt text-success"></i> Destination
                        </label>
                        <div class="input-wrapper">
                            <input
                                class="form-control form-control-custom" 
                                type="text"
                                id="destination"
                                name="destination"
                                placeholder="Ville d'arrivée"
                                required
                                autocomplete="off">
                            <div id="destinationSuggestions" class="suggestions-list"></div>
                        </div>
                    </div>
    
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold" for="date">
                            <i class="bi bi-calendar-event text-success"></i> Date
                        </label>
                        <input
                            class="form-control form-control-custom" 
                            type="date"
                            id="date"
                            name="date"
                            required>
                    </div>

                    <div class="col-12 col-md-3">
                        <button type="submit" class="btn btn-search w-100">
                            <i class="bi bi-search"></i> Rechercher
                        </button>
                    </div>
                </form> 
            </div>   
        </div>
    </section>

    <section class="section-explain container-xxl py-5">
        <h2 class="mb-4 fw-bold presentation-title text-center">Comment ça marche ?</h2>
        <div class="row g-4">
            <!-- Carte 1 -->
            <div class="col-12 col-md-4">
                <div class="explain-card text-center h-100">
                    <div class="explain-icon mb-3">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3 class="explain-title">Rechercher un covoiturage</h3>
                    <p class="explain-text">Trouvez facilement un covoiturage en indiquant votre point de départ, votre destination et la date souhaitée.</p>
                </div>
             </div>
    
            <!-- Carte 2 -->
            <div class="col-12 col-md-4">
                <div class="explain-card text-center h-100">
                    <div class="explain-icon mb-3">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <h3 class="explain-title">Réserver votre trajet</h3>
                    <p class="explain-text">Choisissez le conducteur qui vous convient et réservez votre place en quelques clics.</p>
                </div>
            </div>
    
            <!-- Carte 3 -->
            <div class="col-12 col-md-4">
                <div class="explain-card text-center h-100">
                    <div class="explain-icon mb-3">
                        <i class="bi bi-credit-card"></i>
                    </div>
                    <h3 class="explain-title">Payer en toute sécurité</h3>
                    <p class="explain-text">Effectuez votre paiement de manière sécurisée et voyagez l'esprit tranquille.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="section-presentation container-xxl py-5">
        <h2 class="mb-4 fw-bold presentation-title text-center">La vision EcoRide</h2>  
        <div class="row align-items-center g-4">
            <div class="col-12 col-lg-6">
                <img src="img/ecoride-presentation-photo.jpg" alt="Présentation EcoRide" class="img-fluid rounded-3 shadow">
            </div>
            
            <div class="col-12 col-lg-6">
                <p class="presentation-text">Alors que le réchauffement climatique et la pollution s'aggravent un peu plus chaque jour, chacun tente d'agir à son échelle, et c'est ainsi qu'est né le projet EcoRide.</p>
                <p class="presentation-text">Une équipe dévouée qui s'est donné une mission : permettre à chacun d'entre nous d'oeuvrer pour la planète, en voyageant de façon écologique et solidaire.</p>
                <p class="presentation-text">Rejoignez notre communauté et participez activement à la réduction de l'empreinte carbone liée aux déplacements.</p>
            </div>
        </div> 
    </section>

</main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration
            const MIN_CHARS = 2;
            const DEBOUNCE_DELAY = 300;
            
            /**
             * Configure l'autocomplétion pour un champ de ville
             */
            function setupCityAutocomplete(inputId, suggestionsId) {
                const input = document.getElementById(inputId);
                const suggestionsDiv = document.getElementById(suggestionsId);
                let debounceTimer;
                let selectedCity = null;
                
                // Écouter la saisie dans l'input
                input.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    const query = this.value.trim();
                    selectedCity = null; // Réinitialiser la sélection
                    
                    if (query.length < MIN_CHARS) {
                        suggestionsDiv.style.display = 'none';
                        return;
                    }
                    
                    // Debounce pour éviter trop de requêtes
                    debounceTimer = setTimeout(() => {
                        fetchCities(query, suggestionsDiv, input);
                    }, DEBOUNCE_DELAY);
                });
                
                // Navigation au clavier
                input.addEventListener('keydown', function(e) {
                    const items = suggestionsDiv.querySelectorAll('.suggestion-item');
                    const activeItem = suggestionsDiv.querySelector('.suggestion-item.active');
                    
                    if (e.key === 'ArrowDown' && items.length > 0) {
                        e.preventDefault();
                        if (!activeItem) {
                            items[0].classList.add('active');
                        } else {
                            const nextItem = activeItem.nextElementSibling;
                            if (nextItem) {
                                activeItem.classList.remove('active');
                                nextItem.classList.add('active');
                            }
                        }
                    } else if (e.key === 'ArrowUp' && items.length > 0) {
                        e.preventDefault();
                        if (activeItem) {
                            const prevItem = activeItem.previousElementSibling;
                            if (prevItem) {
                                activeItem.classList.remove('active');
                                prevItem.classList.add('active');
                            }
                        }
                    } else if (e.key === 'Enter' && activeItem) {
                        e.preventDefault();
                        activeItem.click();
                    } else if (e.key === 'Escape') {
                        suggestionsDiv.style.display = 'none';
                    }
                });
                
                // Fermer les suggestions si on clique ailleurs
                document.addEventListener('click', function(e) {
                    if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                        suggestionsDiv.style.display = 'none';
                    }
                });
            }
            
            /**
             * Récupère les villes depuis l'API
             */
            async function fetchCities(query, suggestionsDiv, input) {
                try {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted"><i class="bi bi-hourglass-split me-2"></i>Recherche en cours...</div>';
                    suggestionsDiv.style.display = 'block';
                    
                    const response = await fetch(
                        `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&fields=nom,code,codesPostaux,codeDepartement,population&boost=population&limit=8`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Erreur de recherche');
                    }
                    
                    const cities = await response.json();
                    displaySuggestions(cities, suggestionsDiv, input);
                    
                } catch (error) {
                    console.error('Erreur lors de la recherche:', error);
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Erreur de chargement</div>';
                    suggestionsDiv.style.display = 'block';
                }
            }
            
            /**
             * Affiche les suggestions de villes
             */
            function displaySuggestions(cities, suggestionsDiv, input) {
                if (cities.length === 0) {
                    suggestionsDiv.innerHTML = '<div class="suggestion-item text-muted"><i class="bi bi-info-circle me-2"></i>Aucune ville trouvée</div>';
                    suggestionsDiv.style.display = 'block';
                    return;
                }
                
                suggestionsDiv.innerHTML = '';
                
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    const cityName = city.nom;
                    const postcode = city.codesPostaux ? city.codesPostaux[0] : '';
                    const dept = city.codeDepartement || '';
                    
                    item.innerHTML = `
                        <div class="suggestion-city">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>${cityName}</span>
                            ${postcode ? `<span class="suggestion-postcode">(${postcode})</span>` : ''}
                        </div>
                        ${dept ? `<div class="suggestion-context">Département ${dept}</div>` : ''}
                    `;
                    
                    // Sélection d'une ville
                    item.addEventListener('click', function() {
                        input.value = cityName;
                        input.dataset.cityCode = city.code;
                        input.dataset.cityPostcode = postcode;
                        suggestionsDiv.style.display = 'none';
                    });
                    
                    suggestionsDiv.appendChild(item);
                });
                
                suggestionsDiv.style.display = 'block';
            }
            
            // Initialiser l'autocomplétion pour les deux champs
            setupCityAutocomplete('departure', 'departureSuggestions');
            setupCityAutocomplete('destination', 'destinationSuggestions');
        });
    </script>
{% endblock %}